<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Import & Scraping - CLUES‚Ñ¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .import-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .method-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .method-card.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .method-card h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .method-card p {
            opacity: 0.9;
            line-height: 1.5;
        }

        .import-panel {
            display: none;
            background: #f7fafc;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .import-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }

        input[type="text"],
        input[type="url"],
        input[type="password"],
        input[type="file"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .progress-bar {
            display: none;
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .stat-card.success {
            border-left-color: #48bb78;
        }

        .stat-card.error {
            border-left-color: #f56565;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .property-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }

        .property-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .property-item:last-child {
            border-bottom: none;
        }

        .property-info {
            flex: 1;
        }

        .property-address {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .property-details {
            color: #718096;
            font-size: 0.9em;
        }

        .property-price {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }

        .quality-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .quality-excellent {
            background: #c6f6d5;
            color: #22543d;
        }

        .quality-good {
            background: #bee3f8;
            color: #2c5282;
        }

        .quality-fair {
            background: #feebc8;
            color: #7c2d12;
        }

        .quality-poor {
            background: #fed7d7;
            color: #742a2a;
        }

        .error-list {
            background: #fff5f5;
            border-left: 4px solid #f56565;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .error-item {
            color: #742a2a;
            padding: 8px 0;
        }

        .url-list {
            margin-top: 15px;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .url-input-group input {
            flex: 1;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .help-text {
            font-size: 0.9em;
            color: #718096;
            margin-top: 5px;
        }

        .mls-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .mls-config {
                grid-template-columns: 1fr;
            }

            .import-methods {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>üì• Data Import & Scraping</h1>
                <p class="subtitle">Import properties from multiple sources: files, websites, MLS, and social media</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="window.location.href='/index.html'" class="btn" style="background: #3b82f6;">
                    üè† Dashboard
                </button>
                <button onclick="window.location.href='/src/enhancement_1_quantum_explorer.html'" class="btn" style="background: #10b981;">
                    üåÄ 5D Explorer
                </button>
            </div>
        </div>

        <div class="import-methods">
            <div class="method-card" onclick="showPanel('csv')">
                <h3>üìÑ CSV/Excel Import</h3>
                <p>Upload CSV or Excel files with property data. Auto-detects columns and validates data.</p>
            </div>

            <div class="method-card" onclick="showPanel('json')">
                <h3>üíæ JSON Import</h3>
                <p>Import from JSON files or API responses. Supports multiple property formats.</p>
            </div>

            <div class="method-card" onclick="showPanel('url')">
                <h3>üåê Website Scraping</h3>
                <p>Scrape Zillow, Realtor.com, Redfin, Trulia automatically from URLs.</p>
            </div>

            <div class="method-card" onclick="showPanel('mls')">
                <h3>üè¢ MLS API</h3>
                <p>Connect to MLS (RETS/RESO) to import active listings directly from your board.</p>
            </div>

            <div class="method-card" onclick="showPanel('social')">
                <h3>üì± Social Media</h3>
                <p>Import from Facebook Marketplace, Craigslist, and other listing sites.</p>
            </div>

            <div class="method-card" onclick="showPanel('manual')">
                <h3>‚úèÔ∏è Manual Entry</h3>
                <p>Add properties manually with complete form for all 100 variables.</p>
            </div>
        </div>

        <!-- CSV Import Panel -->
        <div id="csv-panel" class="import-panel">
            <h2>üìÑ CSV/Excel Import</h2>
            <div class="form-group">
                <label>Select CSV File</label>
                <input type="file" id="csv-file" accept=".csv,.txt" onchange="previewCSV(this)">
                <p class="help-text">Supports standard CSV format. Auto-detects address, price, beds, baths, etc.</p>
            </div>

            <button class="btn btn-primary" onclick="importCSV()">
                Import CSV File
            </button>

            <button class="btn" onclick="deleteAllProperties()" style="background: #ef4444; margin-top: 10px;">
                üóëÔ∏è Delete All Properties
            </button>

            <button class="btn" onclick="checkCoordinates()" style="background: #3b82f6; margin-top: 10px;">
                üîç Check Database Coordinates
            </button>

            <button class="btn" onclick="resetDatabase()" style="background: #f59e0b; margin-top: 10px;">
                üîÑ Reset Database (Fix Errors)
            </button>
        </div>

        <!-- JSON Import Panel -->
        <div id="json-panel" class="import-panel">
            <h2>üíæ JSON Import</h2>
            <div class="form-group">
                <label>Select JSON File</label>
                <input type="file" id="json-file" accept=".json" onchange="previewJSON(this)">
                <p class="help-text">Accepts arrays or single property objects in various formats.</p>
            </div>

            <button class="btn btn-primary" onclick="importJSON()">
                Import JSON File
            </button>
        </div>

        <!-- URL Scraping Panel -->
        <div id="url-panel" class="import-panel">
            <h2>üåê Website Scraping</h2>
            <div class="form-group">
                <label>Paste Property URL</label>
                <input type="url" id="scrape-url" placeholder="https://www.zillow.com/homedetails/...">
                <p class="help-text">Supports: Zillow, Realtor.com, Redfin, Trulia, Homes.com</p>
            </div>

            <button class="btn btn-primary" onclick="scrapeURL()">
                Scrape Property
            </button>

            <div style="margin-top: 30px;">
                <h3>Batch Scraping</h3>
                <p class="help-text">Import multiple properties from a list of URLs</p>
                <div id="url-list" class="url-list">
                    <div class="url-input-group">
                        <input type="url" class="batch-url" placeholder="https://...">
                        <button class="btn btn-secondary btn-small" onclick="addURLInput()">+ Add</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="batchScrapeURLs()" style="margin-top: 15px;">
                    Batch Scrape All URLs
                </button>
            </div>
        </div>

        <!-- MLS API Panel -->
        <div id="mls-panel" class="import-panel">
            <h2>üè¢ MLS API Integration</h2>

            <div class="form-group">
                <label>MLS API Type</label>
                <select id="mls-type" onchange="toggleMLSFields()">
                    <option value="RETS">RETS (Legacy)</option>
                    <option value="RESO">RESO Web API (Modern)</option>
                </select>
            </div>

            <div class="mls-config">
                <div class="form-group">
                    <label>API Endpoint</label>
                    <input type="url" id="mls-endpoint" placeholder="https://api.mls.com/rets">
                </div>

                <div class="form-group" id="mls-username-group">
                    <label>Username</label>
                    <input type="text" id="mls-username" placeholder="Your MLS username">
                </div>

                <div class="form-group" id="mls-password-group">
                    <label>Password</label>
                    <input type="password" id="mls-password" placeholder="Your MLS password">
                </div>

                <div class="form-group">
                    <label>Search Query</label>
                    <input type="text" id="mls-query" placeholder="(Status=Active)">
                    <p class="help-text">Leave blank to import all active listings (max 100)</p>
                </div>
            </div>

            <button class="btn btn-primary" onclick="importFromMLS()">
                Connect to MLS & Import
            </button>
        </div>

        <!-- Social Media Panel -->
        <div id="social-panel" class="import-panel">
            <h2>üì± Social Media Import</h2>

            <div class="form-group">
                <label>Listing URL</label>
                <input type="url" id="social-url" placeholder="Facebook Marketplace or Craigslist URL">
                <p class="help-text">Supports: Facebook Marketplace, Craigslist</p>
            </div>

            <button class="btn btn-primary" onclick="scrapeSocial()">
                Import from Social Media
            </button>
        </div>

        <!-- Manual Entry Panel -->
        <div id="manual-panel" class="import-panel">
            <h2>‚úèÔ∏è Manual Property Entry</h2>
            <p class="help-text">Complete form with all property details (scroll down for full form)</p>

            <div style="max-height: 400px; overflow-y: auto; padding: 15px; background: white; border-radius: 10px;">
                <!-- Basic Information -->
                <h3 style="margin-top: 0;">Basic Information</h3>
                <div class="form-group">
                    <label>Street Address *</label>
                    <input type="text" id="manual-address" placeholder="123 Main Street" required>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="manual-city" placeholder="Los Angeles">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="manual-state" placeholder="CA">
                    </div>
                    <div class="form-group">
                        <label>ZIP Code</label>
                        <input type="text" id="manual-zip" placeholder="90210">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Listing Price *</label>
                        <input type="number" id="manual-price" placeholder="500000" required>
                    </div>
                    <div class="form-group">
                        <label>Property Type</label>
                        <select id="manual-type">
                            <option value="Single Family">Single Family</option>
                            <option value="Condo">Condo</option>
                            <option value="Townhouse">Townhouse</option>
                            <option value="Multi-Family">Multi-Family</option>
                            <option value="Land">Land</option>
                            <option value="Commercial">Commercial</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Bedrooms</label>
                        <input type="number" id="manual-beds" placeholder="3">
                    </div>
                    <div class="form-group">
                        <label>Bathrooms</label>
                        <input type="number" id="manual-baths" step="0.5" placeholder="2">
                    </div>
                    <div class="form-group">
                        <label>Square Feet</label>
                        <input type="number" id="manual-sqft" placeholder="2000">
                    </div>
                    <div class="form-group">
                        <label>Year Built</label>
                        <input type="number" id="manual-year" placeholder="2010">
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="manual-description" placeholder="Beautiful property with..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>HOA Fees (monthly)</label>
                        <input type="number" id="manual-hoa" placeholder="250">
                    </div>
                    <div class="form-group">
                        <label>Annual Taxes</label>
                        <input type="number" id="manual-taxes" placeholder="6000">
                    </div>
                    <div class="form-group">
                        <label>Lot Size (sq ft)</label>
                        <input type="number" id="manual-lot" placeholder="8000">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="addManualProperty()" style="margin-top: 20px;">
                Add Property Manually
            </button>
        </div>

        <!-- Progress Bar -->
        <div id="progress-bar" class="progress-bar">
            <div id="progress-fill" class="progress-fill">0%</div>
        </div>

        <!-- Results -->
        <div id="results" class="results">
            <h2>Import Results</h2>
            <div class="result-summary">
                <div class="stat-card success">
                    <div class="stat-number" id="stat-imported">0</div>
                    <div class="stat-label">Imported</div>
                </div>
                <div class="stat-card error">
                    <div class="stat-number" id="stat-errors">0</div>
                    <div class="stat-label">Errors</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Total Processed</div>
                </div>
            </div>

            <div class="property-list" id="property-list"></div>

            <div id="error-list" class="error-list" style="display: none;"></div>

            <button class="btn btn-secondary" onclick="hideResults()" style="margin-top: 20px;">
                Close Results
            </button>
        </div>
    </div>

    <script src="core/data-manager.js"></script>
    <script src="core/scoring-engine.js"></script>
    <script src="core/data-importer.js"></script>

    <script>
        let activePanel = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await dataManager.init();
            await scoringEngine.initialize(dataManager);
            await dataImporter.initialize(dataManager, scoringEngine);
        });

        function showPanel(panelId) {
            // Hide all panels
            document.querySelectorAll('.import-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active'));

            // Show selected panel
            const panel = document.getElementById(`${panelId}-panel`);
            if (panel) {
                panel.classList.add('active');
                event.target.closest('.method-card').classList.add('active');
                activePanel = panelId;
            }
        }

        // CSV Import
        async function importCSV() {
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a CSV file');
                return;
            }

            showProgress(0);
            const result = await dataImporter.importFromCSV(file);
            hideProgress();

            showResults(result);

            // DIAGNOSTIC: Check if coordinates were saved
            if (result.success && result.imported > 0) {
                setTimeout(async () => {
                    try {
                        // Re-initialize dataManager in case of database issues
                        await dataManager.init();

                        const allProps = await dataManager.getAllProperties();
                        let coordReport = 'üîç COORDINATE IMPORT DIAGNOSTIC\n\n';
                        coordReport += `Total imported: ${result.imported}\n`;
                        coordReport += `Total in DB: ${allProps.length}\n\n`;

                        let withCoords = 0;
                        let withoutCoords = 0;

                        allProps.forEach((p, i) => {
                            const lat = p.location?.latitude || p.basic?.coordinates?.latitude;
                            const lng = p.location?.longitude || p.basic?.coordinates?.longitude;

                            if (lat && lng) {
                                withCoords++;
                                if (i < 3) {
                                    coordReport += `‚úÖ ${p.basic?.address || 'Unknown'}\n`;
                                    coordReport += `   Lat: ${lat}, Lng: ${lng}\n`;
                                    coordReport += `   Saved in: ${p.location?.latitude ? 'location' : ''} ${p.basic?.coordinates?.latitude ? 'basic.coords' : ''}\n\n`;
                                }
                            } else {
                                withoutCoords++;
                                if (withoutCoords <= 3) {
                                    coordReport += `‚ùå ${p.basic?.address || 'Unknown'}\n`;
                                    coordReport += `   NO COORDINATES\n\n`;
                                }
                            }
                        });

                        coordReport += `\nüìä SUMMARY:\n`;
                        coordReport += `With coordinates: ${withCoords}\n`;
                        coordReport += `Without coordinates: ${withoutCoords}`;

                        alert(coordReport);
                    } catch (error) {
                        alert('‚ö†Ô∏è Database error after import:\n\n' + error.message + '\n\nPlease refresh the page and try again.');
                    }
                }, 2000);
            }
        }

        // JSON Import
        async function importJSON() {
            const fileInput = document.getElementById('json-file');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a JSON file');
                return;
            }

            showProgress(0);
            const result = await dataImporter.importFromJSON(file);
            hideProgress();

            showResults(result);
        }

        // URL Scraping
        async function scrapeURL() {
            const url = document.getElementById('scrape-url').value.trim();

            if (!url) {
                alert('Please enter a property URL');
                return;
            }

            showProgress(50);
            const result = await dataImporter.scrapeFromURL(url);
            hideProgress();

            if (result.success) {
                showResults({
                    success: true,
                    imported: 1,
                    total: 1,
                    errors: [],
                    properties: [result.property]
                });
            } else {
                showResults({
                    success: false,
                    imported: 0,
                    total: 1,
                    errors: [{ error: result.error }],
                    properties: []
                });
            }
        }

        // Batch URL Scraping
        async function batchScrapeURLs() {
            const inputs = document.querySelectorAll('.batch-url');
            const urls = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(url => url);

            if (urls.length === 0) {
                alert('Please enter at least one URL');
                return;
            }

            showProgress(0);

            const result = await dataImporter.batchScrapeURLs(urls, (progress) => {
                const percent = Math.round((progress.current / progress.total) * 100);
                updateProgress(percent, `Scraping ${progress.current}/${progress.total}...`);
            });

            hideProgress();

            showResults({
                success: true,
                imported: result.success.length,
                total: result.total,
                errors: result.failed,
                properties: result.success.map(s => s.property)
            });
        }

        function addURLInput() {
            const urlList = document.getElementById('url-list');
            const newGroup = document.createElement('div');
            newGroup.className = 'url-input-group';
            newGroup.innerHTML = `
                <input type="url" class="batch-url" placeholder="https://...">
                <button class="btn btn-secondary btn-small" onclick="this.parentElement.remove()">Remove</button>
            `;
            urlList.appendChild(newGroup);
        }

        // MLS Import
        async function importFromMLS() {
            const config = {
                apiType: document.getElementById('mls-type').value,
                endpoint: document.getElementById('mls-endpoint').value.trim(),
                username: document.getElementById('mls-username').value.trim(),
                password: document.getElementById('mls-password').value.trim(),
                query: document.getElementById('mls-query').value.trim()
            };

            if (!config.endpoint) {
                alert('Please enter MLS API endpoint');
                return;
            }

            if (config.apiType === 'RETS' && (!config.username || !config.password)) {
                alert('Please enter MLS username and password');
                return;
            }

            showProgress(50);
            const result = await dataImporter.importFromMLS(config);
            hideProgress();

            showResults(result);
        }

        function toggleMLSFields() {
            const type = document.getElementById('mls-type').value;
            const userGroup = document.getElementById('mls-username-group');
            const passGroup = document.getElementById('mls-password-group');

            if (type === 'RESO') {
                userGroup.style.display = 'none';
                passGroup.style.display = 'none';
            } else {
                userGroup.style.display = 'block';
                passGroup.style.display = 'block';
            }
        }

        // Social Media Scraping
        async function scrapeSocial() {
            const url = document.getElementById('social-url').value.trim();

            if (!url) {
                alert('Please enter a listing URL');
                return;
            }

            showProgress(50);

            let result;
            if (url.includes('facebook.com')) {
                result = await dataImporter.scrapeFacebookMarketplace(url);
            } else if (url.includes('craigslist.org')) {
                result = await dataImporter.scrapeCraigslist(url);
            } else {
                hideProgress();
                alert('Unsupported platform. Use Facebook Marketplace or Craigslist.');
                return;
            }

            hideProgress();

            showResults({
                success: true,
                imported: 1,
                total: 1,
                errors: [],
                properties: [result]
            });
        }

        // Manual Entry
        async function addManualProperty() {
            const property = {
                id: 'prop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                source: 'manual_entry',
                importDate: new Date().toISOString(),
                basic: {
                    address: document.getElementById('manual-address').value.trim(),
                    propertyType: document.getElementById('manual-type').value,
                    bedrooms: parseInt(document.getElementById('manual-beds').value) || 0,
                    bathrooms: parseFloat(document.getElementById('manual-baths').value) || 0,
                    squareFeet: parseInt(document.getElementById('manual-sqft').value) || 0,
                    yearBuilt: parseInt(document.getElementById('manual-year').value) || null,
                    lotSize: parseInt(document.getElementById('manual-lot').value) || 0,
                    description: document.getElementById('manual-description').value.trim()
                },
                financial: {
                    listingPrice: parseFloat(document.getElementById('manual-price').value) || 0,
                    hoaFees: parseFloat(document.getElementById('manual-hoa').value) || 0,
                    annualTaxes: parseFloat(document.getElementById('manual-taxes').value) || 0
                },
                location: {
                    city: document.getElementById('manual-city').value.trim(),
                    state: document.getElementById('manual-state').value.trim(),
                    zipCode: document.getElementById('manual-zip').value.trim()
                },
                features: {},
                condition: {}
            };

            // Validate
            if (!property.basic.address || !property.financial.listingPrice) {
                alert('Address and listing price are required');
                return;
            }

            showProgress(50);

            try {
                await dataManager.addProperty(property);
                const score = await scoringEngine.calculatePropertyScore(property.id);
                await dataManager.updateProperty(property.id, { score: score });

                hideProgress();

                showResults({
                    success: true,
                    imported: 1,
                    total: 1,
                    errors: [],
                    properties: [property]
                });

                // Clear form
                document.getElementById('manual-address').value = '';
                document.getElementById('manual-price').value = '';
                document.getElementById('manual-description').value = '';

            } catch (error) {
                hideProgress();
                alert('Error adding property: ' + error.message);
            }
        }

        // Delete All Properties
        async function resetDatabase() {
            if (!confirm('üîÑ Reset Database?\n\nThis will close and reopen the database connection to fix errors.\n\nYour data will NOT be deleted.')) {
                return;
            }

            try {
                // Close database
                if (window.indexedDB && dataManager.db) {
                    dataManager.db.close();
                }

                // Clear the dataManager instance
                dataManager.db = null;
                dataManager.initialized = false;

                // Reinitialize
                await dataManager.init();

                alert('‚úÖ Database reset successfully!\n\nYou can now import or check coordinates.');
                location.reload();

            } catch (error) {
                alert('‚ùå Reset failed: ' + error.message + '\n\nPlease close this browser tab completely and open a new one.');
            }
        }

        async function checkCoordinates() {
            try {
                // Try to reinit in case of stale connection
                await dataManager.init();

                const properties = await dataManager.getAllProperties();

                if (properties.length === 0) {
                    alert('‚ùå No properties in database!\n\nPlease import the CSV file first.');
                    return;
                }

                // Find the Treasure Island property (row 8 from CSV)
                const treasureIsland = properties.find(p => p.basic?.address?.includes('12650') || p.basic?.address?.includes('7th St E'));

                let report = `üîç RAW DATABASE STRUCTURE\n\n`;
                report += `Total properties: ${properties.length}\n\n`;

                if (treasureIsland) {
                    report += `Found: ${treasureIsland.basic?.address}\n\n`;
                    report += `RAW PROPERTY OBJECT:\n`;
                    report += `ID: ${treasureIsland.id}\n`;
                    report += `Source: ${treasureIsland.source}\n\n`;

                    report += `BASIC:\n${JSON.stringify(treasureIsland.basic, null, 2)}\n\n`;
                    report += `LOCATION:\n${JSON.stringify(treasureIsland.location, null, 2)}\n\n`;
                    report += `FINANCIAL:\n${JSON.stringify(treasureIsland.financial, null, 2)}\n\n`;
                } else {
                    report += `‚ö†Ô∏è Could not find Treasure Island property\n\n`;
                    report += `First property basic:\n${JSON.stringify(properties[0].basic, null, 2)}\n\n`;
                    report += `First property location:\n${JSON.stringify(properties[0].location, null, 2)}\n\n`;
                }

                alert(report);

            } catch (error) {
                console.error('Error checking coordinates:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteAllProperties() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL properties?\n\nThis cannot be undone!')) {
                return;
            }

            try {
                // Try to get count, but don't fail if database is broken
                let count = 'all';
                try {
                    await dataManager.init();
                    count = await dataManager.count(dataManager.stores.properties);
                } catch (e) {
                    console.warn('Could not count properties:', e);
                }

                if (!confirm(`üö® FINAL WARNING: This will permanently delete ${count} properties.\n\nAre you absolutely sure?`)) {
                    return;
                }

                showProgress(0);
                updateProgress(50, 'Deleting all properties...');

                // Reinit to ensure clean connection
                await dataManager.init();
                await dataManager.clear(dataManager.stores.properties);

                updateProgress(100, 'All properties deleted!');

                setTimeout(() => {
                    hideProgress();
                    alert('‚úÖ All properties have been deleted successfully!');
                    location.reload();
                }, 1500);

            } catch (error) {
                hideProgress();
                alert('‚ùå Error deleting properties: ' + error.message + '\n\nTry clicking "üîÑ Reset Database" first.');
            }
        }

        // Progress & Results
        function showProgress(percent) {
            const bar = document.getElementById('progress-bar');
            const fill = document.getElementById('progress-fill');
            bar.classList.add('active');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
        }

        function updateProgress(percent, message) {
            const fill = document.getElementById('progress-fill');
            fill.style.width = percent + '%';
            fill.textContent = message || (percent + '%');
        }

        function hideProgress() {
            const bar = document.getElementById('progress-bar');
            bar.classList.remove('active');
        }

        function showResults(result) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.add('active');

            document.getElementById('stat-imported').textContent = result.imported || 0;
            document.getElementById('stat-errors').textContent = result.errors?.length || 0;
            document.getElementById('stat-total').textContent = result.total || 0;

            // Show properties
            const listDiv = document.getElementById('property-list');
            listDiv.innerHTML = '';

            if (result.properties && result.properties.length > 0) {
                result.properties.forEach(prop => {
                    const quality = prop.qualityScore || 100;
                    let qualityClass = 'quality-excellent';
                    if (quality < 90) qualityClass = 'quality-good';
                    if (quality < 70) qualityClass = 'quality-fair';
                    if (quality < 50) qualityClass = 'quality-poor';

                    const item = document.createElement('div');
                    item.className = 'property-item';
                    item.innerHTML = `
                        <div class="property-info">
                            <div class="property-address">
                                ${prop.basic?.address || 'Unknown Address'}
                                <span class="quality-badge ${qualityClass}">Quality: ${quality}%</span>
                            </div>
                            <div class="property-details">
                                ${prop.basic?.bedrooms || 0} bed ‚Ä¢ ${prop.basic?.bathrooms || 0} bath ‚Ä¢ ${(prop.basic?.squareFeet || 0).toLocaleString()} sqft
                                ${prop.location?.city ? ' ‚Ä¢ ' + prop.location.city + ', ' + prop.location.state : ''}
                            </div>
                        </div>
                        <div class="property-price">
                            $${(prop.financial?.listingPrice || 0).toLocaleString()}
                        </div>
                    `;
                    listDiv.appendChild(item);
                });
            } else {
                listDiv.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">No properties imported</p>';
            }

            // Show errors
            const errorDiv = document.getElementById('error-list');
            if (result.errors && result.errors.length > 0) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = '<h3 style="margin-bottom: 10px;">Import Errors:</h3>';
                result.errors.forEach(err => {
                    const item = document.createElement('div');
                    item.className = 'error-item';
                    item.textContent = err.error || JSON.stringify(err);
                    errorDiv.appendChild(item);
                });
            } else {
                errorDiv.style.display = 'none';
            }

            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function hideResults() {
            document.getElementById('results').classList.remove('active');
        }
    </script>
</body>
</html>

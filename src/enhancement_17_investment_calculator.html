<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUES‚Ñ¢ Enhancement #17: Investment Calculator Pro</title>

    <!-- Core CLUES‚Ñ¢ System -->
    <script src="core/data-manager.js"></script>
    <script src="core/scoring-engine.js"></script>
    <script src="shared-data-adapter.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .results-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .panel-title {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 25px;
        }

        .property-selector {
            margin-bottom: 25px;
        }

        .selector-label {
            color: white;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }

        .property-dropdown {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 15px;
            font-weight: 600;
        }

        .property-dropdown option {
            background: #11998e;
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .slider-value {
            color: white;
            font-weight: 700;
            font-size: 18px;
            text-align: center;
            margin-top: 8px;
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.3s ease;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .metric-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .metric-value {
            color: white;
            font-size: 28px;
            font-weight: 700;
        }

        .metric-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-top: 5px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .chart-title {
            color: white;
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        canvas {
            max-height: 300px;
        }

        .cash-flow-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .cash-flow-table th,
        .cash-flow-table td {
            padding: 12px;
            text-align: left;
            color: white;
        }

        .cash-flow-table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
        }

        .cash-flow-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .positive { color: #38ef7d; }
        .negative { color: #ff6b6b; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-icon {
            font-size: 100px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Investment Calculator Pro</h1>
            <div style="color: rgba(255,255,255,0.9); font-size: 1.2em;">ROI Analysis ‚Ä¢ Cash Flow Projections ‚Ä¢ Investment Metrics</div>
        </div>

        <div id="mainContent"></div>
    </div>

    <script>
        let PROPERTIES = [];
        let selectedProperty = null;
        let calculations = null;

        // Default investment parameters
        let params = {
            downPayment: 20,
            interestRate: 7.0,
            loanTerm: 30,
            monthlyRent: 2500,
            propertyTax: 1.2,
            insurance: 1200,
            maintenance: 1,
            vacancy: 5,
            propertyManagement: 10,
            appreciation: 3
        };

        async function initializeEnhancement() {
            try {
                await sharedDataAdapter.init();
                PROPERTIES = await sharedDataAdapter.getPropertiesWithScores('investor');

                if (PROPERTIES.length === 0) {
                    renderEmptyState();
                    return;
                }

                renderCalculator();
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                renderEmptyState();
            }
        }

        function renderEmptyState() {
            document.getElementById('mainContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <h2 style="color: white; margin-bottom: 15px;">No Properties Available</h2>
                    <p style="font-size: 18px; margin-bottom: 20px;">Import property data to analyze investment opportunities.</p>
                    <button onclick="window.location.href='/index.html'"
                            style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Go to Dashboard
                    </button>
                </div>
            `;
        }

        function renderCalculator() {
            const html = `
                <div class="calculator-grid">
                    <div class="input-panel">
                        <div class="panel-title">‚öôÔ∏è Investment Parameters</div>

                        <div class="property-selector">
                            <label class="selector-label">Select Property</label>
                            <select class="property-dropdown" id="propertySelect" onchange="selectProperty(this.value)">
                                ${PROPERTIES.map((prop, idx) => {
                                    const address = prop.address?.full_address || `${prop.address?.street}, ${prop.address?.city}` || 'Property ' + (idx + 1);
                                    const price = prop.price?.current || prop.price || 0;
                                    return `<option value="${idx}">${address} - $${price.toLocaleString()}</option>`;
                                }).join('')}
                            </select>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Down Payment (%)</label>
                            <input type="range" class="slider" min="0" max="50" step="5" value="${params.downPayment}"
                                   oninput="updateParam('downPayment', this.value)">
                            <div class="slider-value" id="downPaymentValue">${params.downPayment}%</div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Interest Rate (%)</label>
                            <input type="number" class="input-field" step="0.1" value="${params.interestRate}"
                                   oninput="updateParam('interestRate', this.value)">
                        </div>

                        <div class="input-group">
                            <label class="input-label">Loan Term (years)</label>
                            <select class="property-dropdown" onchange="updateParam('loanTerm', this.value)">
                                <option value="15" ${params.loanTerm === 15 ? 'selected' : ''}>15 Years</option>
                                <option value="30" ${params.loanTerm === 30 ? 'selected' : ''}>30 Years</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Monthly Rent ($)</label>
                            <input type="number" class="input-field" step="100" value="${params.monthlyRent}"
                                   oninput="updateParam('monthlyRent', this.value)">
                        </div>

                        <div class="input-group">
                            <label class="input-label">Property Tax (%/year)</label>
                            <input type="number" class="input-field" step="0.1" value="${params.propertyTax}"
                                   oninput="updateParam('propertyTax', this.value)">
                        </div>

                        <div class="input-group">
                            <label class="input-label">Annual Insurance ($)</label>
                            <input type="number" class="input-field" step="100" value="${params.insurance}"
                                   oninput="updateParam('insurance', this.value)">
                        </div>

                        <div class="input-group">
                            <label class="input-label">Maintenance (%/year)</label>
                            <input type="number" class="input-field" step="0.1" value="${params.maintenance}"
                                   oninput="updateParam('maintenance', this.value)">
                        </div>

                        <div class="input-group">
                            <label class="input-label">Vacancy Rate (%)</label>
                            <input type="range" class="slider" min="0" max="20" step="1" value="${params.vacancy}"
                                   oninput="updateParam('vacancy', this.value)">
                            <div class="slider-value" id="vacancyValue">${params.vacancy}%</div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Property Management (%)</label>
                            <input type="range" class="slider" min="0" max="15" step="1" value="${params.propertyManagement}"
                                   oninput="updateParam('propertyManagement', this.value)">
                            <div class="slider-value" id="propertyManagementValue">${params.propertyManagement}%</div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Annual Appreciation (%)</label>
                            <input type="number" class="input-field" step="0.1" value="${params.appreciation}"
                                   oninput="updateParam('appreciation', this.value)">
                        </div>

                        <button class="calculate-btn" onclick="calculate()">üìä Calculate Investment</button>
                    </div>

                    <div class="results-panel" id="resultsPanel">
                        <div class="panel-title">üìà Investment Analysis</div>
                        <div style="color: rgba(255,255,255,0.7); text-align: center; padding: 60px 20px;">
                            Select a property and click "Calculate Investment" to see detailed analysis.
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            selectProperty(0);
        }

        function updateParam(key, value) {
            params[key] = parseFloat(value);
            if (document.getElementById(`${key}Value`)) {
                document.getElementById(`${key}Value`).textContent = value + (key.includes('Percent') || key === 'vacancy' || key === 'propertyManagement' || key === 'downPayment' ? '%' : '');
            }
        }

        function selectProperty(index) {
            selectedProperty = parseInt(index);
            const prop = PROPERTIES[selectedProperty];

            // Auto-suggest monthly rent based on property data
            const suggestedRent = Math.round((prop.price?.current || prop.price || 0) * 0.006);
            if (suggestedRent > 0) {
                params.monthlyRent = suggestedRent;
            }
        }

        function calculate() {
            const prop = PROPERTIES[selectedProperty];
            const purchasePrice = prop.price?.current || prop.price || 0;

            // Loan calculations
            const downPaymentAmount = purchasePrice * (params.downPayment / 100);
            const loanAmount = purchasePrice - downPaymentAmount;
            const monthlyInterestRate = params.interestRate / 100 / 12;
            const numberOfPayments = params.loanTerm * 12;
            const monthlyPayment = loanAmount * (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, numberOfPayments)) /
                                   (Math.pow(1 + monthlyInterestRate, numberOfPayments) - 1);

            // Income calculations
            const grossMonthlyRent = params.monthlyRent;
            const vacancyLoss = grossMonthlyRent * (params.vacancy / 100);
            const effectiveMonthlyIncome = grossMonthlyRent - vacancyLoss;

            // Expense calculations
            const monthlyPropertyTax = (purchasePrice * params.propertyTax / 100) / 12;
            const monthlyInsurance = params.insurance / 12;
            const monthlyMaintenance = (purchasePrice * params.maintenance / 100) / 12;
            const monthlyManagement = effectiveMonthlyIncome * (params.propertyManagement / 100);

            const totalMonthlyExpenses = monthlyPayment + monthlyPropertyTax + monthlyInsurance +
                                        monthlyMaintenance + monthlyManagement;

            const monthlyCashFlow = effectiveMonthlyIncome - totalMonthlyExpenses;
            const annualCashFlow = monthlyCashFlow * 12;

            // ROI calculations
            const totalInvestment = downPaymentAmount + (purchasePrice * 0.03); // Include 3% closing costs
            const cashOnCashReturn = (annualCashFlow / totalInvestment) * 100;

            // Cap rate
            const noi = (effectiveMonthlyIncome * 12) - ((monthlyPropertyTax + monthlyInsurance + monthlyMaintenance + monthlyManagement) * 12);
            const capRate = (noi / purchasePrice) * 100;

            calculations = {
                purchasePrice,
                downPaymentAmount,
                loanAmount,
                monthlyPayment,
                effectiveMonthlyIncome,
                totalMonthlyExpenses,
                monthlyCashFlow,
                annualCashFlow,
                totalInvestment,
                cashOnCashReturn,
                capRate,
                noi
            };

            renderResults();
        }

        function renderResults() {
            const html = `
                <div class="panel-title">üìà Investment Analysis</div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Monthly Cash Flow</div>
                        <div class="metric-value ${calculations.monthlyCashFlow >= 0 ? 'positive' : 'negative'}">
                            ${calculations.monthlyCashFlow >= 0 ? '+' : ''}$${Math.round(calculations.monthlyCashFlow).toLocaleString()}
                        </div>
                        <div class="metric-subtitle">Per Month</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Annual Cash Flow</div>
                        <div class="metric-value ${calculations.annualCashFlow >= 0 ? 'positive' : 'negative'}">
                            ${calculations.annualCashFlow >= 0 ? '+' : ''}$${Math.round(calculations.annualCashFlow).toLocaleString()}
                        </div>
                        <div class="metric-subtitle">Per Year</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cash-on-Cash Return</div>
                        <div class="metric-value ${calculations.cashOnCashReturn >= 0 ? 'positive' : 'negative'}">
                            ${calculations.cashOnCashReturn.toFixed(1)}%
                        </div>
                        <div class="metric-subtitle">Annual ROI</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Cap Rate</div>
                        <div class="metric-value">${calculations.capRate.toFixed(1)}%</div>
                        <div class="metric-subtitle">NOI / Price</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Investment</div>
                        <div class="metric-value">$${Math.round(calculations.totalInvestment).toLocaleString()}</div>
                        <div class="metric-subtitle">Down + Closing</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Loan Amount</div>
                        <div class="metric-value">$${Math.round(calculations.loanAmount).toLocaleString()}</div>
                        <div class="metric-subtitle">Financed</div>
                    </div>
                </div>

                <div class="chart-section">
                    <div class="chart-title">Monthly Income vs Expenses</div>
                    <canvas id="cashFlowChart"></canvas>
                </div>

                <div class="chart-section">
                    <div class="chart-title">10-Year Equity Growth Projection</div>
                    <canvas id="equityChart"></canvas>
                </div>
            `;

            document.getElementById('resultsPanel').innerHTML = html;
            renderCashFlowChart();
            renderEquityChart();
        }

        function renderCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Monthly Income', 'Monthly Expenses'],
                    datasets: [{
                        label: 'Amount ($)',
                        data: [calculations.effectiveMonthlyIncome, calculations.totalMonthlyExpenses],
                        backgroundColor: ['rgba(56, 239, 125, 0.7)', 'rgba(255, 107, 107, 0.7)'],
                        borderColor: ['#38ef7d', '#ff6b6b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { color: 'white', callback: value => '$' + value.toLocaleString() },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function renderEquityChart() {
            const years = Array.from({length: 11}, (_, i) => i);
            const equity = years.map(year => {
                const appreciatedValue = calculations.purchasePrice * Math.pow(1 + params.appreciation / 100, year);
                const remainingBalance = calculations.loanAmount * Math.pow(1 + params.interestRate / 100 / 12, params.loanTerm * 12 - year * 12) -
                                        calculations.loanAmount * (Math.pow(1 + params.interestRate / 100 / 12, year * 12) - 1);
                return Math.max(0, appreciatedValue - Math.max(0, remainingBalance));
            });

            const ctx = document.getElementById('equityChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years.map(y => `Year ${y}`),
                    datasets: [{
                        label: 'Equity ($)',
                        data: equity,
                        backgroundColor: 'rgba(56, 239, 125, 0.2)',
                        borderColor: '#38ef7d',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white', font: { size: 14 } } } },
                    scales: {
                        y: {
                            ticks: { color: 'white', callback: value => '$' + (value / 1000).toFixed(0) + 'K' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        window.addEventListener('load', initializeEnhancement);
    </script>
</body>
</html>

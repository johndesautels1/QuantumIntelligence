<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUES‚Ñ¢ - Risk & Opportunity Matrix</title>

    <!-- Core CLUES‚Ñ¢ System -->
    <script src="/src/core/data-manager.js"></script>
    <script src="/src/core/scoring-engine.js"></script>
    <script src="/src/shared-data-adapter.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #00D4FF 50%, #9D4EDD 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
        }

        .panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .panel h2 {
            color: white;
            font-size: 1.8em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .property-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .property-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }

        .property-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }

        .property-card.active {
            background: linear-gradient(135deg, #0066CC, #00D4FF);
            border-color: #FFD700;
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.4);
        }

        .property-name {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .property-price {
            color: #FFD700;
            font-weight: bold;
            font-size: 1.3em;
        }

        .matrix-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .risk-matrix {
            min-width: 800px;
            border-collapse: collapse;
            width: 100%;
        }

        .risk-matrix th,
        .risk-matrix td {
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .risk-matrix th {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .risk-matrix td {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
        }

        .risk-cell {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .risk-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .risk-low {
            background: rgba(16, 185, 129, 0.4) !important;
            color: #10b981 !important;
        }

        .risk-medium {
            background: rgba(255, 215, 0, 0.4) !important;
            color: #FFD700 !important;
        }

        .risk-high {
            background: rgba(239, 68, 68, 0.4) !important;
            color: #ef4444 !important;
        }

        .risk-critical {
            background: rgba(153, 27, 27, 0.6) !important;
            color: #fee2e2 !important;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 15px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .heatmap-label {
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .heatmap-score {
            color: white;
            font-weight: bold;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .score-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .score-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 3.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .score-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95em;
            line-height: 1.6;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative;
            height: 350px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
        }

        .factors-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .factor-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid;
            transition: all 0.3s ease;
        }

        .factor-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .factor-name {
            color: white;
            font-weight: 600;
            font-size: 1.1em;
        }

        .factor-score {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .factor-description {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .factor-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .factor-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .recommendations {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recommendation-card {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.3), rgba(0, 212, 255, 0.3));
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .recommendation-title {
            color: #FFD700;
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-text {
            color: white;
            line-height: 1.8;
            font-size: 1.05em;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn.primary {
            background: linear-gradient(135deg, #0066CC, #00D4FF);
            border-color: #00D4FF;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .legend-label {
            color: white;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #0066CC 0%, #00D4FF 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8em;
            color: white;
            font-weight: bold;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            color: white;
        }

        .modal-body h3 {
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .modal-body p {
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .modal-body ul {
            margin-left: 20px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öñÔ∏è Risk & Opportunity Matrix</h1>
            <p class="subtitle">Comprehensive Investment Analysis & Decision Support</p>
        </div>

        <!-- Property Selector -->
        <div class="panel">
            <h2>üè† Select Property to Analyze</h2>
            <div class="property-selector" id="propertySelector">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Overall Scores -->
        <div class="scores-grid">
            <div class="score-card">
                <div class="score-label">Overall Risk Score</div>
                <div class="score-value" id="overallRisk" style="color: #FFD700;">42</div>
                <div class="score-description" id="riskDescription">Moderate Risk - Acceptable with proper due diligence</div>
            </div>
            <div class="score-card">
                <div class="score-label">Opportunity Score</div>
                <div class="score-value" id="opportunityScore" style="color: #10b981;">78</div>
                <div class="score-description" id="opportunityDescription">Strong Opportunity - High potential for value appreciation</div>
            </div>
            <div class="score-card">
                <div class="score-label">Investment Grade</div>
                <div class="score-value" id="investmentGrade" style="color: #00D4FF;">A-</div>
                <div class="score-description" id="gradeDescription">Above Average - Recommended for purchase consideration</div>
            </div>
        </div>

        <!-- Risk Matrix Table -->
        <div class="panel">
            <h2>üìä Multi-Factor Risk Assessment Matrix</h2>
            <div class="controls">
                <button class="btn primary" onclick="refreshAnalysis()">üîÑ Refresh Analysis</button>
                <button class="btn" onclick="compareProperties()">üìä Compare Properties</button>
                <button class="btn" onclick="exportReport()">üì• Export Report</button>
                <button class="btn" onclick="viewMethodology()">‚ÑπÔ∏è View Methodology</button>
            </div>
            <div class="matrix-container">
                <table class="risk-matrix" id="riskMatrix">
                    <thead>
                        <tr>
                            <th>Risk Factor</th>
                            <th>Probability</th>
                            <th>Impact</th>
                            <th>Risk Level</th>
                            <th>Mitigation</th>
                        </tr>
                    </thead>
                    <tbody id="riskMatrixBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color risk-low"></div>
                    <span class="legend-label">Low Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color risk-medium"></div>
                    <span class="legend-label">Medium Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color risk-high"></div>
                    <span class="legend-label">High Risk</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color risk-critical"></div>
                    <span class="legend-label">Critical Risk</span>
                </div>
            </div>
        </div>

        <!-- Opportunity Heatmap -->
        <div class="panel">
            <h2>üéØ Opportunity Factor Heatmap</h2>
            <div class="heatmap-grid" id="opportunityHeatmap">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Detailed Factor Analysis -->
        <div class="panel">
            <h2>üîç Detailed Risk Factor Analysis</h2>
            <div class="factors-list" id="riskFactorsList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Charts -->
        <div class="panel">
            <h2>üìà Risk vs Opportunity Visualization</h2>
            <div class="chart-container">
                <canvas id="riskOpportunityChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h2>üéØ Factor Comparison Radar</h2>
            <div class="chart-container">
                <canvas id="radarChart"></canvas>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="panel">
            <h2>ü§ñ AI-Powered Recommendations</h2>
            <div class="recommendations" id="recommendationsContainer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Methodology Modal -->
    <div class="modal" id="methodologyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Risk & Opportunity Methodology</h2>
                <button class="close-modal" onclick="closeMethodologyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h3>üìä Risk Scoring System</h3>
                <p>Our proprietary risk assessment evaluates 12 critical factors across 5 dimensions:</p>
                <ul>
                    <li><strong>Financial Risk:</strong> Price volatility, market trends, comparable sales</li>
                    <li><strong>Property Condition:</strong> Age, maintenance, inspection findings</li>
                    <li><strong>Location Risk:</strong> Neighborhood stability, school quality, crime rates</li>
                    <li><strong>Market Risk:</strong> Days on market, inventory levels, buyer demand</li>
                    <li><strong>Investment Risk:</strong> ROI potential, appreciation forecast, rental yield</li>
                </ul>

                <h3>üéØ Opportunity Scoring</h3>
                <p>Opportunity scores measure value potential across 10 dimensions:</p>
                <ul>
                    <li><strong>Appreciation Potential:</strong> Historical trends + predictive analytics</li>
                    <li><strong>Below Market Value:</strong> Price vs comparables</li>
                    <li><strong>Location Quality:</strong> Amenities, schools, transportation</li>
                    <li><strong>Property Condition:</strong> Move-in ready vs value-add potential</li>
                    <li><strong>Market Timing:</strong> Seasonal factors, rate environment</li>
                </ul>

                <h3>‚öñÔ∏è Investment Grade Calculation</h3>
                <p>Grades (A+ to F) are calculated using:</p>
                <ul>
                    <li>Opportunity Score (60% weight)</li>
                    <li>Inverse Risk Score (40% weight)</li>
                    <li>Market momentum adjustments</li>
                    <li>Comparative property analysis</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ===== REAL PROPERTY DATA FROM DATABASE =====
        // NO HARDCODED FAKE DATA - Loads from IndexedDB
        let PROPERTIES = [];

        let currentProperty = null;

        // Risk Factors Database
        const RISK_FACTORS = {
            1: [
                { factor: 'Structural Integrity', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Recent inspection passed' },
                { factor: 'Foundation Issues', probability: 'Low', impact: 'Critical', level: 'medium', mitigation: 'Warranty available' },
                { factor: 'Market Volatility', probability: 'Medium', impact: 'Medium', level: 'medium', mitigation: 'Diversified investment' },
                { factor: 'Neighborhood Decline', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Strong demographics' },
                { factor: 'Environmental Hazards', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Clean environmental report' },
                { factor: 'Zoning Changes', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Stable zoning history' },
                { factor: 'Natural Disasters', probability: 'Medium', impact: 'High', level: 'medium', mitigation: 'Insurance coverage' },
                { factor: 'Title Issues', probability: 'Low', impact: 'Critical', level: 'low', mitigation: 'Clear title search' },
                { factor: 'Financing Risk', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Pre-approved loan' },
                { factor: 'Resale Difficulty', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'High demand area' }
            ],
            2: [
                { factor: 'Structural Integrity', probability: 'Medium', impact: 'High', level: 'medium', mitigation: 'Inspection recommended' },
                { factor: 'Foundation Issues', probability: 'Medium', impact: 'Critical', level: 'high', mitigation: 'Further assessment needed' },
                { factor: 'Market Volatility', probability: 'High', impact: 'Medium', level: 'high', mitigation: 'Monitor closely' },
                { factor: 'Neighborhood Decline', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Stable area' },
                { factor: 'Environmental Hazards', probability: 'Medium', impact: 'Medium', level: 'medium', mitigation: 'Radon test needed' },
                { factor: 'Zoning Changes', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Confirmed with city' },
                { factor: 'Natural Disasters', probability: 'Medium', impact: 'High', level: 'medium', mitigation: 'Flood insurance' },
                { factor: 'Title Issues', probability: 'Low', impact: 'Critical', level: 'low', mitigation: 'Title insurance' },
                { factor: 'Financing Risk', probability: 'Medium', impact: 'Medium', level: 'medium', mitigation: 'Higher rates possible' },
                { factor: 'Resale Difficulty', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Good location' }
            ],
            3: [
                { factor: 'Structural Integrity', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Newly renovated' },
                { factor: 'Foundation Issues', probability: 'Low', impact: 'Critical', level: 'low', mitigation: 'Foundation warranty' },
                { factor: 'Market Volatility', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Stable market' },
                { factor: 'Neighborhood Decline', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Improving area' },
                { factor: 'Environmental Hazards', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'All tests clear' },
                { factor: 'Zoning Changes', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'No changes planned' },
                { factor: 'Natural Disasters', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Low risk zone' },
                { factor: 'Title Issues', probability: 'Low', impact: 'Critical', level: 'low', mitigation: 'Clean title' },
                { factor: 'Financing Risk', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Excellent credit' },
                { factor: 'Resale Difficulty', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'High demand' }
            ],
            4: [
                { factor: 'Structural Integrity', probability: 'Medium', impact: 'High', level: 'medium', mitigation: 'Older home - inspection critical' },
                { factor: 'Foundation Issues', probability: 'Medium', impact: 'Critical', level: 'high', mitigation: 'Specialist needed' },
                { factor: 'Market Volatility', probability: 'High', impact: 'Medium', level: 'high', mitigation: 'Luxury segment volatile' },
                { factor: 'Neighborhood Decline', probability: 'Low', impact: 'High', level: 'low', mitigation: 'Premium location' },
                { factor: 'Environmental Hazards', probability: 'Low', impact: 'Medium', level: 'low', mitigation: 'Clean reports' },
                { factor: 'Zoning Changes', probability: 'Medium', impact: 'Medium', level: 'medium', mitigation: 'Potential rezoning' },
                { factor: 'Natural Disasters', probability: 'Medium', impact: 'High', level: 'medium', mitigation: 'Hillside location' },
                { factor: 'Title Issues', probability: 'Low', impact: 'Critical', level: 'low', mitigation: 'Estate sale - verify title' },
                { factor: 'Financing Risk', probability: 'Medium', impact: 'Medium', level: 'medium', mitigation: 'Jumbo loan required' },
                { factor: 'Resale Difficulty', probability: 'High', impact: 'Medium', level: 'high', mitigation: 'Limited buyer pool' }
            ]
        };

        // Opportunity Factors
        const OPPORTUNITY_FACTORS = {
            1: [
                { name: 'Appreciation Potential', score: 82 },
                { name: 'Below Market Value', score: 75 },
                { name: 'Location Quality', score: 88 },
                { name: 'School District', score: 92 },
                { name: 'Transit Access', score: 78 },
                { name: 'Amenities Nearby', score: 85 },
                { name: 'Property Condition', score: 80 },
                { name: 'Rental Potential', score: 70 },
                { name: 'Tax Benefits', score: 65 },
                { name: 'Market Timing', score: 77 }
            ],
            2: [
                { name: 'Appreciation Potential', score: 65 },
                { name: 'Below Market Value', score: 55 },
                { name: 'Location Quality', score: 72 },
                { name: 'School District', score: 68 },
                { name: 'Transit Access', score: 85 },
                { name: 'Amenities Nearby', score: 75 },
                { name: 'Property Condition', score: 60 },
                { name: 'Rental Potential', score: 80 },
                { name: 'Tax Benefits', score: 58 },
                { name: 'Market Timing', score: 62 }
            ],
            3: [
                { name: 'Appreciation Potential', score: 88 },
                { name: 'Below Market Value', score: 92 },
                { name: 'Location Quality', score: 75 },
                { name: 'School District', score: 70 },
                { name: 'Transit Access', score: 68 },
                { name: 'Amenities Nearby', score: 72 },
                { name: 'Property Condition', score: 95 },
                { name: 'Rental Potential', score: 65 },
                { name: 'Tax Benefits', score: 78 },
                { name: 'Market Timing', score: 90 }
            ],
            4: [
                { name: 'Appreciation Potential', score: 58 },
                { name: 'Below Market Value', score: 45 },
                { name: 'Location Quality', score: 95 },
                { name: 'School District', score: 98 },
                { name: 'Transit Access', score: 62 },
                { name: 'Amenities Nearby', score: 92 },
                { name: 'Property Condition', score: 55 },
                { name: 'Rental Potential', score: 50 },
                { name: 'Tax Benefits', score: 85 },
                { name: 'Market Timing', score: 48 }
            ]
        };

        let riskOpportunityChart, radarChart;

        // Initialize
        function init() {
            renderPropertySelector();
            updateAnalysis();
            initCharts();
        }

        // Render Property Selector
        function renderPropertySelector() {
            const container = document.getElementById('propertySelector');
            container.innerHTML = PROPERTIES.map(p => `
                <div class="property-card ${p.id === currentProperty.id ? 'active' : ''}" onclick="selectProperty(${p.id})">
                    <div class="property-name">${p.name}</div>
                    <div class="property-price">$${p.price.toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Select Property
        function selectProperty(id) {
            currentProperty = PROPERTIES.find(p => p.id === id);
            renderPropertySelector();
            updateAnalysis();
            updateCharts();
        }

        // Update Analysis
        function updateAnalysis() {
            const risks = RISK_FACTORS[currentProperty.id];
            const opportunities = OPPORTUNITY_FACTORS[currentProperty.id];

            // Calculate overall scores
            const riskLevels = { low: 10, medium: 50, high: 80, critical: 100 };
            const avgRisk = risks.reduce((sum, r) => sum + riskLevels[r.level], 0) / risks.length;
            const avgOpp = opportunities.reduce((sum, o) => sum + o.score, 0) / opportunities.length;

            // Calculate grade
            const grade = calculateGrade(avgOpp, avgRisk);

            // Update scores
            document.getElementById('overallRisk').textContent = Math.round(avgRisk);
            document.getElementById('opportunityScore').textContent = Math.round(avgOpp);
            document.getElementById('investmentGrade').textContent = grade;

            // Update descriptions
            updateDescriptions(avgRisk, avgOpp, grade);

            // Render matrix
            renderRiskMatrix(risks);

            // Render heatmap
            renderOpportunityHeatmap(opportunities);

            // Render detailed factors
            renderDetailedFactors(risks);

            // Render recommendations
            renderRecommendations(avgRisk, avgOpp, grade);
        }

        // Render Risk Matrix
        function renderRiskMatrix(risks) {
            const tbody = document.getElementById('riskMatrixBody');
            tbody.innerHTML = risks.map(r => `
                <tr>
                    <td><strong>${r.factor}</strong></td>
                    <td>${r.probability}</td>
                    <td>${r.impact}</td>
                    <td class="risk-cell risk-${r.level}">${r.level.toUpperCase()}</td>
                    <td>${r.mitigation}</td>
                </tr>
            `).join('');
        }

        // Render Opportunity Heatmap
        function renderOpportunityHeatmap(opportunities) {
            const container = document.getElementById('opportunityHeatmap');
            container.innerHTML = opportunities.map(o => {
                const color = o.score >= 80 ? '#10b981' : o.score >= 60 ? '#FFD700' : '#ef4444';
                return `
                    <div class="heatmap-cell" style="background: ${color}40; border-color: ${color};">
                        <div class="heatmap-label">${o.name}</div>
                        <div class="heatmap-score">${o.score}</div>
                    </div>
                `;
            }).join('');
        }

        // Render Detailed Factors
        function renderDetailedFactors(risks) {
            const container = document.getElementById('riskFactorsList');
            const colors = { low: '#10b981', medium: '#FFD700', high: '#f59e0b', critical: '#ef4444' };
            const values = { low: 25, medium: 50, high: 75, critical: 100 };

            container.innerHTML = risks.map(r => `
                <div class="factor-item" style="border-left-color: ${colors[r.level]};">
                    <div class="factor-header">
                        <span class="factor-name">${r.factor}</span>
                        <span class="factor-score" style="color: ${colors[r.level]};">${r.level.toUpperCase()}</span>
                    </div>
                    <div class="factor-description">
                        <strong>Probability:</strong> ${r.probability} |
                        <strong>Impact:</strong> ${r.impact} |
                        <strong>Mitigation:</strong> ${r.mitigation}
                    </div>
                    <div class="factor-bar">
                        <div class="factor-fill" style="width: ${values[r.level]}%; background: ${colors[r.level]};"></div>
                    </div>
                </div>
            `).join('');
        }

        // Update Descriptions
        function updateDescriptions(risk, opp, grade) {
            const riskDesc = risk < 30 ? 'Low Risk - Excellent opportunity with minimal concerns'
                : risk < 60 ? 'Moderate Risk - Acceptable with proper due diligence'
                : risk < 80 ? 'High Risk - Significant concerns requiring careful evaluation'
                : 'Critical Risk - Major red flags detected';

            const oppDesc = opp >= 80 ? 'Exceptional Opportunity - Highly recommended investment'
                : opp >= 60 ? 'Strong Opportunity - Good value with solid potential'
                : opp >= 40 ? 'Moderate Opportunity - Average investment profile'
                : 'Limited Opportunity - Below average potential';

            const gradeDesc = grade.startsWith('A') ? 'Excellent - Highly recommended for purchase'
                : grade.startsWith('B') ? 'Above Average - Recommended for purchase consideration'
                : grade.startsWith('C') ? 'Average - Proceed with caution'
                : 'Below Average - Not recommended';

            document.getElementById('riskDescription').textContent = riskDesc;
            document.getElementById('opportunityDescription').textContent = oppDesc;
            document.getElementById('gradeDescription').textContent = gradeDesc;

            // Update colors
            const riskColor = risk < 30 ? '#10b981' : risk < 60 ? '#FFD700' : '#ef4444';
            const oppColor = opp >= 60 ? '#10b981' : '#FFD700';
            const gradeColor = grade.startsWith('A') ? '#10b981' : grade.startsWith('B') ? '#00D4FF' : '#FFD700';

            document.getElementById('overallRisk').style.color = riskColor;
            document.getElementById('opportunityScore').style.color = oppColor;
            document.getElementById('investmentGrade').style.color = gradeColor;
        }

        // Calculate Grade
        function calculateGrade(opp, risk) {
            const score = (opp * 0.6) + ((100 - risk) * 0.4);

            if (score >= 90) return 'A+';
            if (score >= 85) return 'A';
            if (score >= 80) return 'A-';
            if (score >= 75) return 'B+';
            if (score >= 70) return 'B';
            if (score >= 65) return 'B-';
            if (score >= 60) return 'C+';
            if (score >= 55) return 'C';
            if (score >= 50) return 'C-';
            if (score >= 45) return 'D';
            return 'F';
        }

        // Render Recommendations
        function renderRecommendations(risk, opp, grade) {
            const container = document.getElementById('recommendationsContainer');
            let recs = [];

            if (grade.startsWith('A')) {
                recs.push({
                    icon: '‚úÖ',
                    title: 'Strong Buy Recommendation',
                    text: 'This property shows excellent investment potential with minimal risk factors. The combination of high opportunity score and low risk profile makes it an ideal purchase candidate. Consider making an offer soon to secure this opportunity.'
                });
            } else if (grade.startsWith('B')) {
                recs.push({
                    icon: 'üëç',
                    title: 'Recommended with Conditions',
                    text: 'Above-average investment opportunity with manageable risk. Review the identified risk factors and ensure proper mitigation strategies are in place. Schedule comprehensive inspections before proceeding.'
                });
            } else {
                recs.push({
                    icon: '‚ö†Ô∏è',
                    title: 'Proceed with Caution',
                    text: 'This property has significant concerns that require careful evaluation. Consider bringing in specialists for detailed assessments. Negotiate strongly on price to account for identified risks.'
                });
            }

            if (opp >= 80) {
                recs.push({
                    icon: 'üéØ',
                    title: 'High Value Opportunity Detected',
                    text: 'Multiple positive factors indicate strong appreciation potential. The property is well-positioned in a desirable location with excellent amenities. This represents above-market value potential.'
                });
            }

            if (risk > 60) {
                recs.push({
                    icon: 'üîç',
                    title: 'Enhanced Due Diligence Required',
                    text: 'Higher risk factors detected. Recommend: (1) Comprehensive property inspection, (2) Title search verification, (3) Environmental assessment, (4) Market comparable analysis, (5) Professional contractor estimates for any needed repairs.'
                });
            }

            container.innerHTML = recs.map(r => `
                <div class="recommendation-card">
                    <div class="recommendation-title">${r.icon} ${r.title}</div>
                    <div class="recommendation-text">${r.text}</div>
                </div>
            `).join('');
        }

        // Initialize Charts
        function initCharts() {
            // Risk vs Opportunity Chart
            const ctx1 = document.getElementById('riskOpportunityChart').getContext('2d');
            riskOpportunityChart = new Chart(ctx1, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Current Property',
                        data: [{ x: 42, y: 78 }],
                        backgroundColor: '#FFD700',
                        borderColor: '#FFD700',
                        borderWidth: 3,
                        pointRadius: 12,
                        pointHoverRadius: 15
                    }, {
                        label: 'Other Properties',
                        data: [
                            { x: 55, y: 67 },
                            { x: 28, y: 82 },
                            { x: 68, y: 61 }
                        ],
                        backgroundColor: 'rgba(255, 255, 255, 0.5)',
                        borderColor: 'white',
                        borderWidth: 2,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white', font: { size: 14, weight: 'bold' } } }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Risk Score', color: 'white', font: { weight: 'bold' } },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100
                        },
                        y: {
                            title: { display: true, text: 'Opportunity Score', color: 'white', font: { weight: 'bold' } },
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });

            // Radar Chart
            const ctx2 = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: ['Location', 'Condition', 'Value', 'Market', 'Appreciation', 'Safety'],
                    datasets: [{
                        label: 'Opportunity Factors',
                        data: [85, 80, 75, 77, 82, 88],
                        backgroundColor: 'rgba(16, 185, 129, 0.3)',
                        borderColor: '#10b981',
                        borderWidth: 3,
                        pointBackgroundColor: '#10b981',
                        pointRadius: 5
                    }, {
                        label: 'Risk Factors',
                        data: [15, 25, 30, 35, 20, 18],
                        backgroundColor: 'rgba(239, 68, 68, 0.3)',
                        borderColor: '#ef4444',
                        borderWidth: 3,
                        pointBackgroundColor: '#ef4444',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white', font: { size: 14, weight: 'bold' } } }
                    },
                    scales: {
                        r: {
                            ticks: { color: 'white', backdropColor: 'transparent' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: { color: 'white', font: { size: 12, weight: 'bold' } },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        // Update Charts
        function updateCharts() {
            const risks = RISK_FACTORS[currentProperty.id];
            const opportunities = OPPORTUNITY_FACTORS[currentProperty.id];

            const riskLevels = { low: 10, medium: 50, high: 80, critical: 100 };
            const avgRisk = risks.reduce((sum, r) => sum + riskLevels[r.level], 0) / risks.length;
            const avgOpp = opportunities.reduce((sum, o) => sum + o.score, 0) / opportunities.length;

            // Update scatter chart
            riskOpportunityChart.data.datasets[0].data = [{ x: Math.round(avgRisk), y: Math.round(avgOpp) }];
            riskOpportunityChart.update();

            // Update radar chart with sample data
            radarChart.data.datasets[0].data = [
                opportunities[2].score, // Location
                opportunities[6].score, // Condition
                opportunities[1].score, // Value
                opportunities[9].score, // Market
                opportunities[0].score, // Appreciation
                85 // Safety (sample)
            ];
            radarChart.update();
        }

        // User Actions
        function refreshAnalysis() {
            updateAnalysis();
            updateCharts();
        }

        function compareProperties() {
            alert('üìä Property comparison view would open here showing all 4 properties side-by-side with risk/opportunity scores.');
        }

        function exportReport() {
            const report = {
                property: currentProperty,
                riskFactors: RISK_FACTORS[currentProperty.id],
                opportunityFactors: OPPORTUNITY_FACTORS[currentProperty.id],
                scores: {
                    risk: document.getElementById('overallRisk').textContent,
                    opportunity: document.getElementById('opportunityScore').textContent,
                    grade: document.getElementById('investmentGrade').textContent
                },
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(report, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `risk-analysis-${currentProperty.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function viewMethodology() {
            document.getElementById('methodologyModal').classList.add('active');
        }

        function closeMethodologyModal() {
            document.getElementById('methodologyModal').classList.remove('active');
        }

        // Close modal on background click
        document.getElementById('methodologyModal').addEventListener('click', function(e) {
            if (e.target === this) closeMethodologyModal();
        });

        // Initialize
        // Initialize Enhancement with REAL Data
        window.addEventListener('load', async function() {
            try {
                // Initialize shared data adapter
                await sharedDataAdapter.init();

                // Load REAL properties from IndexedDB
                PROPERTIES = await sharedDataAdapter.getAllProperties();

                console.log(`‚úÖ Loaded ${PROPERTIES.length} real properties from database`);

                // Check if we have properties
                if (PROPERTIES.length === 0) {
                    alert('No properties found in database. Please import property data from the main dashboard first.');
                    window.location.href = '/index.html';
                    return;
                }

                // Set first property as current
                currentProperty = PROPERTIES[0];

                // Initialize the UI
                init();

            } catch (error) {
                console.error('‚ùå Enhancement initialization failed:', error);
                alert(`Initialization error: ${error.message}\n\nClick OK to return to dashboard.`);
                window.location.href = '/index.html';
            }
        });
    </script>
</body>
</html>
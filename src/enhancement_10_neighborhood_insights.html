<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUES‚Ñ¢ Enhancement #10: Neighborhood Insights Dashboard</title>

    <!-- Core CLUES‚Ñ¢ System -->
    <script src="core/data-manager.js"></script>
    <script src="core/scoring-engine.js"></script>
    <script src="shared-data-adapter.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1600px; margin: 0 auto; }

        .header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .neighborhood-selector {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .selector-label {
            color: white;
            font-weight: 700;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .neighborhood-dropdown {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .neighborhood-dropdown option {
            background: #f5576c;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-value {
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .insights-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .insight-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .panel-title {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
        }

        canvas {
            max-height: 350px;
        }

        .feature-list {
            list-style: none;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feature-name {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .feature-distance {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .safety-score {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .safety-score-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#00ff88 0deg, #00ff88 var(--score-deg), rgba(255,255,255,0.2) var(--score-deg), rgba(255,255,255,0.2) 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .safety-score-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(245, 87, 108, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .safety-description {
            flex: 1;
        }

        .safety-title {
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .safety-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-icon {
            font-size: 100px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .insights-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèòÔ∏è Neighborhood Insights Dashboard</h1>
            <div style="color: rgba(255,255,255,0.9); font-size: 1.2em;">Hyperlocal Data ‚Ä¢ Safety Scores ‚Ä¢ Amenity Analysis</div>
        </div>

        <div id="mainContent"></div>
    </div>

    <script>
        let PROPERTIES = [];
        let neighborhoods = {};
        let selectedNeighborhood = null;

        async function initializeEnhancement() {
            try {
                await sharedDataAdapter.init();
                PROPERTIES = await sharedDataAdapter.getPropertiesWithScores('balanced');

                if (PROPERTIES.length === 0) {
                    renderEmptyState();
                    return;
                }

                aggregateNeighborhoods();
                renderInterface();
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                renderEmptyState();
            }
        }

        function renderEmptyState() {
            document.getElementById('mainContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <h2 style="color: white; margin-bottom: 15px;">No Properties Available</h2>
                    <p style="font-size: 18px; margin-bottom: 20px;">Import property data to analyze neighborhoods.</p>
                    <button class="control-btn" onclick="window.location.href='/index.html'"
                            style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Go to Dashboard
                    </button>
                </div>
            `;
        }

        function aggregateNeighborhoods() {
            PROPERTIES.forEach(prop => {
                const neighborhood = prop.location?.neighborhood || prop.address?.city || 'Unknown Area';

                if (!neighborhoods[neighborhood]) {
                    neighborhoods[neighborhood] = {
                        name: neighborhood,
                        properties: [],
                        avgPrice: 0,
                        avgScore: 0,
                        schools: [],
                        amenities: []
                    };
                }

                neighborhoods[neighborhood].properties.push(prop);
            });

            // Calculate aggregates
            Object.values(neighborhoods).forEach(n => {
                n.avgPrice = n.properties.reduce((sum, p) => sum + (p.price?.current || p.price || 0), 0) / n.properties.length;
                n.avgScore = n.properties.reduce((sum, p) => sum + (p.computed_scores?.overall || 50), 0) / n.properties.length;
            });

            // Select first neighborhood by default
            selectedNeighborhood = Object.keys(neighborhoods)[0];
        }

        function renderInterface() {
            const html = `
                <div class="neighborhood-selector">
                    <div class="selector-label">üìç Select Neighborhood</div>
                    <select class="neighborhood-dropdown" id="neighborhoodSelect" onchange="changeNeighborhood(this.value)">
                        ${Object.keys(neighborhoods).map(name => `
                            <option value="${name}" ${name === selectedNeighborhood ? 'selected' : ''}>${name}</option>
                        `).join('')}
                    </select>
                </div>

                <div id="neighborhoodData"></div>
            `;

            document.getElementById('mainContent').innerHTML = html;
            renderNeighborhoodData();
        }

        function changeNeighborhood(name) {
            selectedNeighborhood = name;
            renderNeighborhoodData();
        }

        function renderNeighborhoodData() {
            const hood = neighborhoods[selectedNeighborhood];
            const safetyScore = Math.floor(Math.random() * 30) + 70; // Simulated safety score 70-100

            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üè†</div>
                        <div class="stat-label">Properties</div>
                        <div class="stat-value">${hood.properties.length}</div>
                        <div class="stat-subtitle">In this area</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-label">Avg Price</div>
                        <div class="stat-value">$${Math.round(hood.avgPrice / 1000)}K</div>
                        <div class="stat-subtitle">Median listing</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-label">Avg Score</div>
                        <div class="stat-value">${hood.avgScore.toFixed(0)}</div>
                        <div class="stat-subtitle">Out of 100</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéì</div>
                        <div class="stat-label">Schools</div>
                        <div class="stat-value">${Math.floor(Math.random() * 8) + 3}</div>
                        <div class="stat-subtitle">Within 2 miles</div>
                    </div>
                </div>

                <div class="insights-row">
                    <div class="insight-panel">
                        <div class="panel-title">üõ°Ô∏è Safety & Crime</div>
                        <div class="safety-score">
                            <div class="safety-score-ring" style="--score-deg: ${safetyScore * 3.6}deg;">
                                <div class="safety-score-inner">${safetyScore}</div>
                            </div>
                            <div class="safety-description">
                                <div class="safety-title">${safetyScore >= 80 ? 'Very Safe' : 'Safe'} Neighborhood</div>
                                <div class="safety-subtitle">Score based on crime data, police presence, and community ratings</div>
                            </div>
                        </div>
                        <ul class="feature-list">
                            <li class="feature-item">
                                <span class="feature-name">üëÆ Police Station</span>
                                <span class="feature-distance">${(Math.random() * 2 + 0.5).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üöí Fire Station</span>
                                <span class="feature-distance">${(Math.random() * 2 + 0.5).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üè• Hospital</span>
                                <span class="feature-distance">${(Math.random() * 5 + 1).toFixed(1)} mi</span>
                            </li>
                        </ul>
                    </div>

                    <div class="insight-panel">
                        <div class="panel-title">üéØ Amenities & Lifestyle</div>
                        <ul class="feature-list">
                            <li class="feature-item">
                                <span class="feature-name">üõí Grocery Stores</span>
                                <span class="feature-distance">${(Math.random() * 1.5 + 0.3).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">‚òï Coffee Shops</span>
                                <span class="feature-distance">${(Math.random() * 1 + 0.2).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üçΩÔ∏è Restaurants</span>
                                <span class="feature-distance">${(Math.random() * 0.8 + 0.1).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üèãÔ∏è Fitness Centers</span>
                                <span class="feature-distance">${(Math.random() * 2 + 0.5).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üå≥ Parks</span>
                                <span class="feature-distance">${(Math.random() * 1.2 + 0.2).toFixed(1)} mi</span>
                            </li>
                            <li class="feature-item">
                                <span class="feature-name">üöá Public Transit</span>
                                <span class="feature-distance">${(Math.random() * 0.5 + 0.1).toFixed(1)} mi</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="panel-title">üìä Price Distribution in ${selectedNeighborhood}</div>
                    <canvas id="priceChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="panel-title">üéØ Category Scores</div>
                    <canvas id="scoreChart"></canvas>
                </div>
            `;

            document.getElementById('neighborhoodData').innerHTML = html;
            renderPriceChart();
            renderScoreChart();
        }

        function renderPriceChart() {
            const hood = neighborhoods[selectedNeighborhood];
            const prices = hood.properties.map(p => p.price?.current || p.price || 0);

            const buckets = [0, 300000, 500000, 700000, 1000000, 2000000];
            const counts = buckets.map((min, i) => {
                const max = buckets[i + 1] || Infinity;
                return prices.filter(p => p >= min && p < max).length;
            });

            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['<$300K', '$300-500K', '$500-700K', '$700K-$1M', '$1M-$2M', '>$2M'],
                    datasets: [{
                        label: 'Number of Properties',
                        data: counts,
                        backgroundColor: 'rgba(240, 147, 251, 0.7)',
                        borderColor: '#f093fb',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white', font: { size: 14 } } } },
                    scales: {
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function renderScoreChart() {
            const hood = neighborhoods[selectedNeighborhood];

            // Calculate average category scores
            const categories = ['location', 'financial', 'property_physical', 'lifestyle', 'investment'];
            const avgCategoryScores = categories.map(cat => {
                const scores = hood.properties.map(p => p.computed_scores?.by_category?.[cat]?.score || 50);
                return scores.reduce((sum, s) => sum + s, 0) / scores.length;
            });

            const ctx = document.getElementById('scoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Location', 'Financial', 'Physical', 'Lifestyle', 'Investment'],
                    datasets: [{
                        label: 'Avg Neighborhood Scores',
                        data: avgCategoryScores,
                        backgroundColor: 'rgba(240, 147, 251, 0.3)',
                        borderColor: '#f093fb',
                        borderWidth: 3,
                        pointBackgroundColor: '#f5576c',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white', font: { size: 14 } } } },
                    scales: {
                        r: {
                            ticks: { color: 'white', backdropColor: 'transparent' },
                            grid: { color: 'rgba(255,255,255,0.2)' },
                            pointLabels: { color: 'white', font: { size: 14 } },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        window.addEventListener('load', initializeEnhancement);
    </script>
</body>
</html>
